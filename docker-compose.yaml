version: '3.3'

services:
  certbot:
    image: certbot/certbot
    depends_on:
      - nginx
    # Check for certificate renewal every 12h as
    # recomnended by Let's Encryot
    entrypoint: /bin/sh -c \
            'trap exit TERM;
             while :; do
               certbot renew > /dev/null;
               sleep 12h & wait $${!};
             done'
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/files:/etc/letsencrypt

  nginx:
    image: nginx:alpine
    depends_on:
      - php
    restart: always
    # Suppress nginx noise
    tty: false
    # Ensyre renewed certificates are reloaded
    command: /bin/sh -c \
           'while :; do
             sleep 6h & wait $${!};
             nginx -s reload;
           done & nginx -g "daemon off;"'
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./docker/nginx/ssl-common.conf:/etc/nginx/include.d/ssl-common.conf
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./docker/nginx/landing.conf:/etc/nginx/conf.d/landing.conf
      - ./docker/nginx/social.conf:/etc/nginx/conf.d/social.conf
      - ./certbot/www:/var/www/certbot
      - ./certbot/files:/etc/letsencrypt
      - ./social/public:/var/www/social/public
    logging:
      driver: "none"

  php:
    depends_on:
      - wait_for_db
    build: ./docker/php
    restart: always
    tty: true
    ports:
      - 9000:9000
    volumes:
      - ./docker/php/entrypoint.sh:/var/entrypoint.sh
      - ./docker/social/install.sh:/var/entrypoint.d/social_install.sh
      - ./social:/var/www/social
    env_file:
      - ./docker/social/social.env
    command: /var/entrypoint.sh

  db:
    image: mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=foobar
    env_file:
      - ./docker/social/social.env
    volumes:
      - ./docker/mariadb/social.sh:/docker-entrypoint-initdb.d/social.sh
      - ./docker/mariadb/my.cnf:/etc/mysql/my.cnf
      - ./docker/mariadb/mariadb.cnf:/etc/mysql/mariadb.cnf
    logging:
      driver: "none"

  wait_for_db:
    image: dadarek/wait-for-dependencies
    depends_on:
      - db
    command: db:3306
